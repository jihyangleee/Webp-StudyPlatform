<!DOCTYPE html>
<html lang="ko">
<head>
  <div class="notification-wrapper">
  <span id="notification-bell">ğŸ””</span>
  <span id="notification-count" class="badge" style="display: none;"></span>
  <div id="notification-list" class="notification-dropdown" style="display: none;"></div>
  </div>
  <meta charset="UTF-8" />
  <title>SPARK - MYPAGE</title>
  <link rel="stylesheet" href="/stylesheets/myapage.css">
  <link rel="icon" href="/favicon.png" type="image/png">
  <!-- âœ… FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />

  <!-- âœ… FullCalendar JS (global ë²„ì „) -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/google-calendar.global.min.js'></script>
</head>
<body>
 <!-- ajax êµ¬í˜„ -->
<script>
  async function loadNotifications() {
    const res = await fetch('/studyR/notifications');
    const data = await res.json();

    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ í‘œì‹œ
    const count = data.notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notification-count');
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline-block' : 'none';

    // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    const list = document.getElementById('notification-list');
    list.innerHTML = data.notifications.map(n => `
      <div style="padding: 8px; border-bottom: 1px solid #ddd;">
        <div>
          ${n.message}
          <br>
          <small>${new Date(n.timestamp).toLocaleString()}</small>
          ${n.read ? '<span style="color:gray;">[ì½ìŒ]</span>' : '<span style="color:red;">[ì•ˆì½ìŒ]</span>'}
        </div>
        <div style="margin-top:4px;">
          ${!n.read ? `<button onclick="markAsRead('${n.timestamp}')">ì½ìŒ</button>` : ''}
          <button onclick="deleteNoti('${n.timestamp}')">ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
  }

  async function markAsRead(timestamp) {
    await fetch(`/studyR/notifications/${timestamp}/read`, { method: 'POST' });
    loadNotifications();
  }

  async function deleteNoti(timestamp) {
    await fetch(`/studyR/notifications/${timestamp}/delete`, { method: 'POST' });
    loadNotifications();
  }

  document.getElementById('notification-bell').addEventListener('click', () => {
    const list = document.getElementById('notification-list');
    list.style.display = list.style.display === 'none' ? 'block' : 'none';
  });

  // ìµœì´ˆ ì‹¤í–‰ ë° ì£¼ê¸°ì  ê°±ì‹ 
  loadNotifications();
  setInterval(loadNotifications, 5000);
</script>

  <header class="header">
    <div class="logo">
      <img src="/favicon.png" alt="ë¡œê³ " class="favicon">
      <h1>MYPAGE</h1>
    </div>
    <nav class="nav">
      <a href="/studyR/webP">MAIN</a>
      <a href="/login">LOGOUT</a>
    </nav>
  </header>
  <main class="mypage-container">
    <section class="profile-box">
      <p class="profile-label">profile</p>
      <div class="profile-content">
        <div class="profile-img" id="profile-img"></div>
        <div class="profile-text">
          <p id="username">ì´ë¦„</p>
          <p id="email">@seoultech.ac.kr</p>
        </div>
      </div>
    </section>

    <section class="study-box">
      <p class="study-label">MY STUDY</p>
      <div class="filter-buttons">
      
          
      <a href="/studyR/mypage?filter=soon">ë§ˆê° ì„ë°•</a>
      <a href="/studyR/mypage?filter=approved">í•©ê²©</a>
      <a href="/studyR/mypage?filter=pending">ìŠ¹ì¸ ëŒ€ê¸°</a>
    </div>
    </div>
      <ul class="study-list"> <!--ì´ ë¶€ë¶„ì´ studyì˜ ë°ì´í„°ì— ìˆëŠ” ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë‹¤. ê·¸ë˜ì„œ ê±°ê¸°ì— ë¯¸ë¦¬ë‘ë©´ ë ë“¯! ì—¬ëŸ¬ ìŠ¤í„°ë””ë“¤ì„ -->
        <% studies.forEach(study=> { %>
          <li class="study-item">
            <strong>
              <%= study.title %>
            </strong><br>
            <div class="button-group">
              <!-- <form action="/studyR/studies/upload/<%= study.id %>" method="GET" style="display:inline;">
                <button type="submit" class="study-button delete-button">ì—…ë¡œë“œ</button> --> <!--ì—…ë¡œë“œë²„íŠ¼ì„ ë§ˆì´í˜ì´ì§€ì—ì„œ ë§Œë“¤ì§€ ì•„ë‹ˆë©´ ë“±ë¡í˜ì´ì§€ì—ì„œ ë§Œë“¤ì§€ ê³ ë¯¼..-->
              <form action="/studyR/studies/delete/<%= study.id %>" method="POST" style="display:inline;">
                <button type="submit" class="study-button delete-button">ì‚­ì œ</button>
              </form>
              <form action="/studyR/studies/edit/<%= study.id %>" method="GET" style="display:inline;">
                <button type="submit" class="study-button edit-button">ìˆ˜ì •</button>
              </form>
              <form action="/studyR/studies/manage/<%= study.id %>" method="GET" style="display:inline;">
                <button type="submit" class="study-button manage-button">ì§€ì›ì ê´€ë¦¬</button>
              </form>

            </div>
          </li>
          <% }) %>
      </ul>

      <!-- ìŠ¤í„°ë”” ë“±ë¡ -->
      <a class="new-study-btn" id="toStudyWrite">ìƒˆë¡œìš´ ìŠ¤í„°ë”” ë§Œë“¤ê¸°</a>
    </section>

    <hr>
<section class="study-box">
  <p class="study-label"> ìˆ˜ê°• ì¤‘ì¸ ìŠ¤í„°ë””</p>
  <ul class="study-list">
    <% ongoing.forEach(app => { %>
      <li class="study-item">
        <strong><%= app.studyTitle %></strong><br>
        ìƒíƒœ: <%= app.status %>
      </li>
    <% }) %>
  </ul>

  <p class="study-label"> ëŒ€ê¸° ì¤‘ / ë¶ˆí•©ê²©</p>
  <ul class="study-list">
    <% pending.forEach(app => { %>
      <li class="study-item">
        <strong><%= app.studyTitle %></strong><br>
        ìƒíƒœ: <%= app.status || "ëŒ€ê¸° ì¤‘" %><br>
        <form action="/studyR/applications/delete/<%= app.studyId %>" method="POST">
          <button type="submit" class="study-button delete-button">ì‚­ì œ</button>
        </form>
      </li>
    <% }) %>
  </ul>
</section>
</main>
<h1>ë‚´ êµ¬ê¸€ ìº˜ë¦°ë” ë³´ê¸°</h1>
<a href="/calendarR/auth/google">ğŸ“… Google ë¡œê·¸ì¸</a>
<button id="load-events-btn">ğŸ“… ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
<div id="calendar"></div>
  <script>
  const serverEvents = JSON.parse('<%- JSON.stringify(events || []).replace(/\\/g, '\\\\').replace(/'/g, "\\'") %>');
  document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    locale: 'ko',
    eventSources: [
        {
          events: serverEvents
        }
      ], // ì²˜ìŒì—ëŠ” ë¹„ì›Œë‘ 

    select: async function (info) {
      const title = prompt('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      if (!title) return;

      const startTime = prompt('ì‹œì‘ ì‹œê°„ (ì˜ˆ: 09:00)', '09:00');
      if (!startTime) return;

      const endTime = prompt('ì¢…ë£Œ ì‹œê°„ (ì˜ˆ: 10:00)', '10:00');
      if (!endTime) return;

      const startDate = new Date(info.startStr + 'T' + startTime + ':00+09:00');
      const endDate = new Date(info.startStr + 'T' + endTime + ':00+09:00');
      if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);

      const start = startDate.toISOString();
      const end = endDate.toISOString();

      // UIì— ë°”ë¡œ í‘œì‹œ
      calendar.addEvent({
        title: title,
        start: start,
        end: end,
        allDay: false
      });

      // ì„œë²„ë¡œ ì „ì†¡
      await fetch('/calendarR/add-google-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, start, end })
      })
      .then(res => res.text())
      .then(msg => alert(msg));
    }
  });

  calendar.render();

  // âœ… "ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ë°”ê¹¥ì—ì„œ ë”°ë¡œ ì‘ì„±í•´ì•¼ í•¨
  document.getElementById('load-events-btn').addEventListener('click', () => {
    calendar.addEventSource({
      url: '/calendarR/list-google-events',
      method: 'GET',
      failure: function () {
        alert('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    });
  });
});
  </script>
</body>
</html>