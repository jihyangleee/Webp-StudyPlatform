<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SPARK - MYPAGE</title>
  <link rel="stylesheet" href="/stylesheets/myapage.css">
  <link rel="icon" href="/favicon.png" type="image/png">
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="/favicon.png" alt="로고" class="favicon">
      <h1>MYPAGE</h1>
    </div>
    <nav class="nav">
      <a href="/studyR/webP">MAIN</a>
      <a href="/login">LOGOUT</a>
    </nav>
  </header>
  <main class="mypage-container">
    <section class="profile-box">
      <p class="profile-label">profile</p>
      <div class="profile-content">
        <div class="profile-img" id="profile-img"></div>
        <div class="profile-text">
          <p id="username">이름</p>
          <p id="email">@seoultech.ac.kr</p>
        </div>
      </div>
    </section>

    <section class="study-box">
      <p class="study-label">MY STUDY</p>
      <div class="filter-buttons">
      
          
      <a href="/studyR/mypage?filter=soon">마감 임박</a>
      <a href="/studyR/mypage?filter=approved">합격</a>
      <a href="/studyR/mypage?filter=pending">승인 대기</a>
    </div>
    </div>
      <!-- 내가 만든 스터디 목록 -->
<ul class="study-list my-study-list">
  <% studies.forEach(study => { %>
    <li class="study-item">
      <strong><%= study.title %></strong><br>
      <div class="button-group">
        <!-- 스터디 개별 삭제 버튼 (✔ 클래스 명확화) -->
        <button type="button" class="study-button btn-delete-study" data-study-id="<%= study.id %>">삭제</button>
        <a href="/studyR/studies/edit/<%= study.id %>" class="study-button edit-button">수정</a>
        <a href="/studyR/studies/manage/<%= study.id %>" class="study-button manage-button">지원자 관리</a>
      </div>
    </li>
  <% }) %>
</ul>

<!-- 스터디 등록 버튼 -->
<a class="new-study-btn" id="toStudyWrite">새로운 스터디 만들기</a>
</section>

<hr>

<!-- 내가 지원한 스터디 목록 -->
<section class="study-box">
  <form id="form-delete-applications">
    <!-- 지원서 선택 삭제 -->
    <button type="submit" class="study-button btn-delete-selected-applications">선택 삭제</button>

    <p class="study-label">지원한 스터디 목록</p>

    <!-- 합격 -->
    <h3>합격:</h3>
    <ul class="study-list applied-list-pass">
      <% ongoing.forEach(app => { %>
        <li class="study-item">
          <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
          <strong><%= app.studyTitle %></strong><br>
          상태: <%= app.status %><br>
        </li>
      <% }) %>
    </ul>

    <!-- 대기 중 / 불합격 -->
    <h3>대기 중 / 불합격:</h3>
    <ul class="study-list applied-list-pending">
      <% pending.forEach(app => { %>
        <li class="study-item">
          <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
          <strong><%= app.studyTitle %></strong><br>
          상태: <%= app.status || "대기 중" %><br>
        </li>
      <% }) %>
    </ul>
  </form>
</section>



  </main>

   <script>
    document.getElementById('toStudyWrite').addEventListener('click', () => {
      window.location.href = '/studyR/studies/new';  // 스터디 등록 페이지 라우트 URL
    });
  </script>

  <script>
document.addEventListener('DOMContentLoaded', () => {

  // 1. 스터디 개별 삭제
  document.addEventListener('click', async e => {
    const btn = e.target.closest('.btn-delete-study');
    if (!btn) return;

    const id = btn.dataset.studyId;
    if (!id) {
      alert('스터디 ID가 없습니다.');
      return;
    }

    try {
      const res = await fetch(`/studyR/studies/delete/${id}`, {
        method: 'POST'
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text);
      }

      const result = await res.json();
      if (result.redirect) {
        location.href = result.redirect;
      } else {
        alert('삭제 실패');
      }
    } catch (err) {
      console.error('스터디 삭제 실패:', err);
      alert('삭제 중 오류 발생');
    }
  });

  // 2. 지원서 선택 삭제
  const form = document.getElementById('form-delete-applications');
  form.addEventListener('submit', async e => {
    e.preventDefault();

    const checked = [...document.querySelectorAll('.checkbox-delete-application:checked')];
    if (checked.length === 0) return alert('삭제할 항목을 선택하세요.');
    if (!confirm('선택한 항목을 삭제하시겠습니까?')) return;

    const studyIds = checked.map(cb => cb.dataset.studyId);

    try {
      const res = await fetch('/studyR/applications/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studyIds })
      });

      if (res.ok) {
        location.reload();
      } else {
        alert('지원서 삭제 실패');
      }
    } catch (err) {
      console.error('지원서 삭제 실패:', err);
      alert('삭제 중 오류 발생');
    }
  });

  // 3. 새로운 스터디 등록 페이지로 이동
  document.getElementById('toStudyWrite').addEventListener('click', () => {
    window.location.href = '/studyR/studies/new';
  });

});
</script>




</body>
</html>