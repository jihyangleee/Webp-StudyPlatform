<!DOCTYPE html>
<html lang="ko">

<head>

  <meta charset="UTF-8" />
  <title>SPARK - MYPAGE</title>
  <link rel="stylesheet" href="/stylesheets/mypage.css">
  <link rel="icon" href="/images/favicon.png" type="image/png">
  <!--  FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />

  <!--  FullCalendar JS (global ë²„ì „) -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/google-calendar.global.min.js'></script>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/stylesheets/calendar.css" />
  <style>
    #selected-study-info {
      margin-top: 30px;
      padding: 20px 25px;
      border-radius: 12px;
      background-color: #f5f7fa;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      color: #333;
      line-height: 1.6;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      transition: all 0.3s ease;
    }
  </style>
</head>

<body>
  <!-- ajax êµ¬í˜„ -->
  <script>
    async function loadNotifications() {
      const res = await fetch('/studyR/notifications');
      const data = await res.json();

      // ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ í‘œì‹œ
      const count = data.notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notification-count');
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline-block' : 'none';

      // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      const list = document.getElementById('notification-list');
      list.innerHTML = data.notifications.map(n => `
      <div style="padding: 8px; border-bottom: 1px solid #ddd;">
        <div>
          ${n.message}
          <br>
          <small>${new Date(n.timestamp).toLocaleString()}</small>
          ${n.read ? '<span style="color:gray;">[ì½ìŒ]</span>' : '<span style="color:red;">[ì•ˆì½ìŒ]</span>'}
        </div>
        <div style="margin-top:4px;">
          ${!n.read ? `<button onclick="markAsRead('${n.timestamp}')">ì½ìŒ</button>` : ''}
          <button onclick="deleteNoti('${n.timestamp}')">ì‚­ì œ</button>
        </div>
      </div>
    `).join('');
    }

    async function markAsRead(timestamp) {
      await fetch(`/studyR/notifications/${timestamp}/read`, { method: 'POST' });
      loadNotifications();
    }

    async function deleteNoti(timestamp) {
      await fetch(`/studyR/notifications/${timestamp}/delete`, { method: 'POST' });
      loadNotifications();
    }

    document.getElementById('notification-bell').addEventListener('click', () => {
      const list = document.getElementById('notification-list');
      list.style.display = list.style.display === 'none' ? 'block' : 'none';
    });

    // ìµœì´ˆ ì‹¤í–‰ ë° ì£¼ê¸°ì  ê°±ì‹ 
    loadNotifications();
    setInterval(loadNotifications, 5000);
  </script>
  <header class="header">
    <div class="logo">
      <img src="/images/favicon.png" alt="ë¡œê³ " class="favicon">
      <h1>MYPAGE</h1>
    </div>
    <nav class="nav">
      <div class="notification-wrapper">
        <span id="notification-bell">
          <img src="/images/bell.png" alt="ì•Œë¦¼" style="width: 24px; height: 24px;">
        </span>
        <span id="notification-count" class="badge" style="display: none;"></span>
        <div id="notification-list" class="notification-dropdown" style="display: none;"></div>
      </div>
      <a href="/studyR/webP">MAIN</a>
      <a href="/login">LOGOUT</a>
    </nav>
  </header>
<div class="mypage-wrapper">
  <main class="mypage-container">





    <!-- <section class="profile-box">
      <p class="profile-label">profile</p>
      <div class="profile-content">
        <div class="profile-img" id="profile-img"></div>
        <div class="profile-text">
          <div id="username">ì´ë¦„</div>
          <div id="email">@seoultech.ac.kr</div>
        </div>
        <button onclick="location.href='/basicInfo'">íšŒì›ì •ë³´ ë³´ê¸°</button>
      </div>
    </section> -->





    <section class="study-box">
      <p class="study-label">MY STUDY</p>
      <div class="filter-buttons">


        <a href="/studyR/mypage?filter=soon">ë§ˆê° ì„ë°•</a>
        <!-- <a href="/studyR/mypage?filter=approved">í•©ê²©</a>
        <a href="/studyR/mypage?filter=pending">ìŠ¹ì¸ ëŒ€ê¸°</a> -->
        <a href="/studyR/mypage" class="filter-button">ì´ˆê¸°í™”</a>
      </div>

      
      <!-- ë‚´ê°€ ë§Œë“  ìŠ¤í„°ë”” ëª©ë¡ -->
      <ul class="study-list my-study-list">
        <% studies.forEach(study=> { %>
          <li class="study-item">
            <strong>
              <%= study.title %>
            </strong><br>
            <div class="button-group">
              <!-- ìŠ¤í„°ë”” ê°œë³„ ì‚­ì œ ë²„íŠ¼ (âœ” í´ë˜ìŠ¤ ëª…í™•í™”) -->
              <button type="button" class="study-button btn-delete-study" data-study-id="<%= study.id %>">ì‚­ì œ</button>
              <a href="/studyR/studies/edit/<%= study.id %>" class="study-button edit-button">ìˆ˜ì •</a>
              <a href="/studyR/studies/manage/<%= study.id %>" class="study-button manage-button">
                ğŸ‘¥ ì§€ì›ì ê´€ë¦¬
              </a>
            </div>
          </li>
          <% }) %>
      </ul>

      <!-- ìŠ¤í„°ë”” ë“±ë¡ ë²„íŠ¼ -->
      <a class="new-study-btn" id="toStudyWrite">ìƒˆë¡œìš´ ìŠ¤í„°ë”” ë§Œë“¤ê¸°</a>
    </section>


    <!-- ë‚´ê°€ ì§€ì›í•œ ìŠ¤í„°ë”” ëª©ë¡ -->
    <section class="study-box">
      <form id="form-delete-applications">
        <!-- ì§€ì›ì„œ ì„ íƒ ì‚­ì œ -->
        <button type="submit" class="study-button btn-delete-selected-applications">ì„ íƒ ì‚­ì œ</button>

        <p class="study-label">ì§€ì›í•œ ìŠ¤í„°ë”” ëª©ë¡</p>

        <!-- í•©ê²© -->
        <h3>í•©ê²©:</h3>
        <ul class="study-list applied-list-pass">
          <% ongoing.forEach(app=> { %>
            <li class="study-item">
              <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
              <strong>
                <%= app.studyTitle %>
              </strong><br>
              ìƒíƒœ: <%= app.status %><br>
            </li>
            <% }) %>
        </ul>

        <!-- ëŒ€ê¸° ì¤‘ / ë¶ˆí•©ê²© -->
        <h3>ëŒ€ê¸° ì¤‘ / ë¶ˆí•©ê²©:</h3>
        <ul class="study-list applied-list-pending">
          <% pending.forEach(app=> { %>
            <li class="study-item">
              <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
              <strong>
                <%= app.studyTitle %>
              </strong><br>
              ìƒíƒœ: <%= app.status || "ëŒ€ê¸° ì¤‘" %><br>
            </li>
            <% }) %>
        </ul>
      </form>
    </section>
  </main>


  <div class="calendar-container">
    <a href="/calendarR/auth/google" class="button">Google ë¡œê·¸ì¸</a>
    <button id="load-events-btn" class="button">ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="calendar"></div>
    <div id="selected-study-info" style="margin-top: 10px; font-weight: bold;" data-current-title=""></div>

  </div>
</div>

  <script>
    const serverEvents = <%- JSON.stringify(events || []) %>;;
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        locale: 'ko',
        eventSources: [
          {
            events: serverEvents
          }
        ], // ì²˜ìŒì—ëŠ” ë¹„ì›Œë‘ 

        select: async function (info) {
          const title = prompt('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
          if (!title) return;

          const startTime = prompt('ì‹œì‘ ì‹œê°„ (ì˜ˆ: 09:00)', '09:00');
          if (!startTime) return;

          const endTime = prompt('ì¢…ë£Œ ì‹œê°„ (ì˜ˆ: 10:00)', '10:00');
          if (!endTime) return;

          const startDate = new Date(info.startStr + 'T' + startTime + ':00+09:00');
          const endDate = new Date(info.startStr + 'T' + endTime + ':00+09:00');
          if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);

          const start = startDate.toISOString();
          const end = endDate.toISOString();

          // UIì— ë°”ë¡œ í‘œì‹œ
          calendar.addEvent({
            title: title,
            start: start,
            end: end,
            allDay: false
          });

          // ì„œë²„ë¡œ ì „ì†¡
          await fetch('/calendarR/add-google-event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, start, end })
          })
            .then(res => res.text())
            .then(msg => alert(msg));
        }
      });

      calendar.render();
      calendarEl.style.marginTop = "-40px";

      // ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
      document.getElementById('load-events-btn').addEventListener('click', () => {
        calendar.addEventSource({
          url: '/calendarR/list-google-events',
          method: 'GET',
          failure: function () {
            alert('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
          }
        });
      });
    });
  </script>

  <script>
    const studies = <% - JSON.stringify(studies) %>;
    document.addEventListener('DOMContentLoaded', () => {
      // ìŠ¤í„°ë”” ì œëª© í´ë¦­ ì‹œ ìº˜ë¦°ë” ë°‘ì— í‘œì‹œ
      document.querySelectorAll('.my-study-list .study-item strong').forEach(titleEl => {
        titleEl.style.cursor = 'pointer';

        titleEl.addEventListener('click', () => {
          const selectedTitle = titleEl.textContent.trim();
          const infoBox = document.getElementById('selected-study-info');

          // ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ìƒíƒœì—ì„œ ê°™ì€ ì œëª©ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° â†’ ë‹«ê¸°
          if (infoBox.dataset.currentTitle === selectedTitle) {
            infoBox.innerHTML = '';
            infoBox.dataset.currentTitle = ''; // ì´ˆê¸°í™”
            return;
          }

          // studies ë°°ì—´ì—ì„œ í•´ë‹¹ ìŠ¤í„°ë”” ì°¾ê¸°
          const selectedStudy = studies.find(study => study.title.trim() === selectedTitle);

          if (selectedStudy) {
            infoBox.innerHTML = `
          <h3>ì„ íƒí•œ ìŠ¤í„°ë””: ${selectedStudy.title}</h3>
          <div>${selectedStudy.descriptionHtml}</div>
        `;
            infoBox.dataset.currentTitle = selectedStudy.title; // í˜„ì¬ ì—´ë¦° ì œëª© ì €ì¥
          } else {
            infoBox.textContent = `ìŠ¤í„°ë”” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            infoBox.dataset.currentTitle = '';
          }
        });
      });
      // 1. ìŠ¤í„°ë”” ê°œë³„ ì‚­ì œ
      document.addEventListener('click', async e => {
        const btn = e.target.closest('.btn-delete-study');
        if (!btn) return;

        const id = btn.dataset.studyId;
        if (!id) {
          alert('ìŠ¤í„°ë”” IDê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        try {
          const res = await fetch(`/studyR/studies/delete/${id}`, {
            method: 'POST'
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text);
          }

          const result = await res.json();
          if (result.redirect) {
            location.href = result.redirect;
          } else {
            alert('ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch (err) {
          console.error('ìŠ¤í„°ë”” ì‚­ì œ ì‹¤íŒ¨:', err);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        }
      });

      // 2. ì§€ì›ì„œ ì„ íƒ ì‚­ì œ
      const form = document.getElementById('form-delete-applications');
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const checked = [...document.querySelectorAll('.checkbox-delete-application:checked')];
        if (checked.length === 0) return alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
        if (!confirm('ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const studyIds = checked.map(cb => cb.dataset.studyId);

        try {
          const res = await fetch('/studyR/applications/delete-bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studyIds })
          });

          if (res.ok) {
            location.reload();
          } else {
            alert('ì§€ì›ì„œ ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch (err) {
          console.error('ì§€ì›ì„œ ì‚­ì œ ì‹¤íŒ¨:', err);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        }
      });

      // 3. ìƒˆë¡œìš´ ìŠ¤í„°ë”” ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
      document.getElementById('toStudyWrite').addEventListener('click', () => {
        window.location.href = '/studyR/studies/new';
      });

    });
  </script>




</body>

</html>