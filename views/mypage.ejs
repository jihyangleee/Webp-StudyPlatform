<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SPARK - MYPAGE</title>
  <link rel="stylesheet" href="/stylesheets/myapage.css">
  <link rel="icon" href="/favicon.png" type="image/png">
  <!--  FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />

  <!--  FullCalendar JS (global ë²„ì „) -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/google-calendar.global.min.js'></script>
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="/favicon.png" alt="ë¡œê³ " class="favicon">
      <h1>MYPAGE</h1>
    </div>
    <nav class="nav">
      <a href="/studyR/webP">MAIN</a>
      <a href="/login">LOGOUT</a>
    </nav>
  </header>
  <main class="mypage-container">
    <section class="profile-box">
      <p class="profile-label">profile</p>
      <div class="profile-content">
        <div class="profile-img" id="profile-img"></div>
        <div class="profile-text">
          <p id="username">ì´ë¦„</p>
          <p id="email">@seoultech.ac.kr</p>
        </div>
      </div>
    </section>

    <section class="study-box">
      <p class="study-label">MY STUDY</p>
      <div class="filter-buttons">
      
          
      <a href="/studyR/mypage?filter=soon">ë§ˆê° ì„ë°•</a>
      <a href="/studyR/mypage?filter=approved">í•©ê²©</a>
      <a href="/studyR/mypage?filter=pending">ìŠ¹ì¸ ëŒ€ê¸°</a>
    </div>
    </div>
      <!-- ë‚´ê°€ ë§Œë“  ìŠ¤í„°ë”” ëª©ë¡ -->
<ul class="study-list my-study-list">
  <% studies.forEach(study => { %>
    <li class="study-item">
      <strong><%= study.title %></strong><br>
      <div class="button-group">
        <!-- ìŠ¤í„°ë”” ê°œë³„ ì‚­ì œ ë²„íŠ¼ (âœ” í´ë˜ìŠ¤ ëª…í™•í™”) -->
        <button type="button" class="study-button btn-delete-study" data-study-id="<%= study.id %>">ì‚­ì œ</button>
        <a href="/studyR/studies/edit/<%= study.id %>" class="study-button edit-button">ìˆ˜ì •</a>
        <a href="/studyR/studies/manage/<%= study.id %>" class="study-button manage-button">ì§€ì›ì ê´€ë¦¬</a>
      </div>
    </li>
  <% }) %>
</ul>

<!-- ìŠ¤í„°ë”” ë“±ë¡ ë²„íŠ¼ -->
<a class="new-study-btn" id="toStudyWrite">ìƒˆë¡œìš´ ìŠ¤í„°ë”” ë§Œë“¤ê¸°</a>
</section>

<hr>

<!-- ë‚´ê°€ ì§€ì›í•œ ìŠ¤í„°ë”” ëª©ë¡ -->
<section class="study-box">
  <form id="form-delete-applications">
    <!-- ì§€ì›ì„œ ì„ íƒ ì‚­ì œ -->
    <button type="submit" class="study-button btn-delete-selected-applications">ì„ íƒ ì‚­ì œ</button>

    <p class="study-label">ì§€ì›í•œ ìŠ¤í„°ë”” ëª©ë¡</p>

    <!-- í•©ê²© -->
    <h3>í•©ê²©:</h3>
    <ul class="study-list applied-list-pass">
      <% ongoing.forEach(app => { %>
        <li class="study-item">
          <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
          <strong><%= app.studyTitle %></strong><br>
          ìƒíƒœ: <%= app.status %><br>
        </li>
      <% }) %>
    </ul>

    <!-- ëŒ€ê¸° ì¤‘ / ë¶ˆí•©ê²© -->
    <h3>ëŒ€ê¸° ì¤‘ / ë¶ˆí•©ê²©:</h3>
    <ul class="study-list applied-list-pending">
      <% pending.forEach(app => { %>
        <li class="study-item">
          <input type="checkbox" class="checkbox-delete-application" data-study-id="<%= app.studyId %>">
          <strong><%= app.studyTitle %></strong><br>
          ìƒíƒœ: <%= app.status || "ëŒ€ê¸° ì¤‘" %><br>
        </li>
      <% }) %>
    </ul>
  </form>
</section>
</main>
<h1>ë‚´ êµ¬ê¸€ ìº˜ë¦°ë” ë³´ê¸°</h1>
<a href="/calendarR/auth/google">ğŸ“… Google ë¡œê·¸ì¸</a>
<button id="load-events-btn">ğŸ“… ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
<div id="calendar"></div>
  <script>document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    locale: 'ko',
    eventSources: [], // ì²˜ìŒì—ëŠ” ë¹„ì›Œë‘ 

    select: async function (info) {
      const title = prompt('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      if (!title) return;

      const startTime = prompt('ì‹œì‘ ì‹œê°„ (ì˜ˆ: 09:00)', '09:00');
      if (!startTime) return;

      const endTime = prompt('ì¢…ë£Œ ì‹œê°„ (ì˜ˆ: 10:00)', '10:00');
      if (!endTime) return;

      const startDate = new Date(info.startStr + 'T' + startTime + ':00+09:00');
      const endDate = new Date(info.startStr + 'T' + endTime + ':00+09:00');
      if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);

      const start = startDate.toISOString();
      const end = endDate.toISOString();

      // UIì— ë°”ë¡œ í‘œì‹œ
      calendar.addEvent({
        title: title,
        start: start,
        end: end,
        allDay: false
      });

      // ì„œë²„ë¡œ ì „ì†¡
      await fetch('/calendarR/add-google-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, start, end })
      })
      .then(res => res.text())
      .then(msg => alert(msg));
    }
  });

  calendar.render();

  // âœ… "ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ë°”ê¹¥ì—ì„œ ë”°ë¡œ ì‘ì„±í•´ì•¼ í•¨
  document.getElementById('load-events-btn').addEventListener('click', () => {
    calendar.addEventSource({
      url: '/calendarR/list-google-events',
      method: 'GET',
      failure: function () {
        alert('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      }
    });
  });
});
  </script>

  <script>
document.addEventListener('DOMContentLoaded', () => {

  // 1. ìŠ¤í„°ë”” ê°œë³„ ì‚­ì œ
  document.addEventListener('click', async e => {
    const btn = e.target.closest('.btn-delete-study');
    if (!btn) return;

    const id = btn.dataset.studyId;
    if (!id) {
      alert('ìŠ¤í„°ë”” IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      const res = await fetch(`/studyR/studies/delete/${id}`, {
        method: 'POST'
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text);
      }

      const result = await res.json();
      if (result.redirect) {
        location.href = result.redirect;
      } else {
        alert('ì‚­ì œ ì‹¤íŒ¨');
      }
    } catch (err) {
      console.error('ìŠ¤í„°ë”” ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    }
  });

  // 2. ì§€ì›ì„œ ì„ íƒ ì‚­ì œ
  const form = document.getElementById('form-delete-applications');
  form.addEventListener('submit', async e => {
    e.preventDefault();

    const checked = [...document.querySelectorAll('.checkbox-delete-application:checked')];
    if (checked.length === 0) return alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
    if (!confirm('ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const studyIds = checked.map(cb => cb.dataset.studyId);

    try {
      const res = await fetch('/studyR/applications/delete-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studyIds })
      });

      if (res.ok) {
        location.reload();
      } else {
        alert('ì§€ì›ì„œ ì‚­ì œ ì‹¤íŒ¨');
      }
    } catch (err) {
      console.error('ì§€ì›ì„œ ì‚­ì œ ì‹¤íŒ¨:', err);
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    }
  });

  // 3. ìƒˆë¡œìš´ ìŠ¤í„°ë”” ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
  document.getElementById('toStudyWrite').addEventListener('click', () => {
    window.location.href = '/studyR/studies/new';
  });

});
</script>




</body>
</html>